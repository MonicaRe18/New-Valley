<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة مؤشرات الأداء - صندوق استصلاح الأراضي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Animation & Global Styles --- */
        @keyframes sway {
            0% { transform: translateX(0) rotate(0); }
            100% { transform: translateX(-2%) rotate(-0.5deg); }
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f2f5;
        }
        .background-image-container {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 20%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            display: none;
            animation: sway 20s ease-in-out infinite alternate;
        }
        @media (min-width: 1024px) {
            .background-image-container { display: block; }
        }
        #bg-left {
            left: 0;
            background-image: url('https://images.unsplash.com/photo-1560493676-04071c5f467b?q=80&w=1974&auto=format&fit=crop');
        }
        #bg-right {
            right: 0;
            background-image: url('https://images.unsplash.com/photo-1560493676-04071c5f467b?q=80&w=1974&auto=format&fit=crop');
            transform: scaleX(-1);
            animation-direction: alternate-reverse;
        }

        /* --- Layout Containers --- */
        .main-content-area {
            max-width: 1300px;
            margin: 0 auto;
            padding: 1rem;
        }
        .main-container {
             background-color: #f8fafc;
             padding: 1.5rem;
             border-radius: 1.5rem;
             box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        @media (min-width: 768px) {
            .main-container { padding: 2.5rem; }
        }

        /* --- KPI Card Styles --- */
        .kpi-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-card-interactive:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.15);
            cursor: pointer;
        }
        .kpi-title {
            font-size: 1.1rem; 
            font-weight: 600;
            color: #557A46;
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #285430;
            line-height: 1.1;
        }
        .kpi-unit {
            font-size: 1rem; 
            font-weight: 500;
            color: #8C7A6B;
            margin-right: 0.35rem;
        }
        .kpi-card-warning {
            background-color: #FFFBEB;
            border-color: #FBBF24;
        }
        .kpi-card-warning .kpi-title { color: #92400E; }
        .kpi-card-warning .kpi-value { color: #D97706; }
        .kpi-card-warning .kpi-unit { color: #B45309; }
        
        /* --- Trend Card Styles --- */
        .kpi-card-trend {
            background: linear-gradient(145deg, #2d6a4f 0%, #1b4332 100%);
            color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), 0 6px 6px rgba(0,0,0,0.23);
        }
        .kpi-card-trend .kpi-title {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            font-weight: 500;
        }
        .kpi-card-trend .kpi-value {
            color: white;
            font-size: 2.25rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .kpi-card-trend .kpi-unit {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        .kpi-card-trend .trend-indicator-wrapper {
            margin: 0.5rem auto 0;
            display: flex;
            justify-content: center;
        }
        .kpi-card-trend .trend-indicator {
            width: 60px; height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
        }
        .kpi-card-trend .trend-indicator.up {
            color: #4ade80; 
            background-color: rgba(74, 222, 128, 0.15);
            border: 2px solid rgba(74, 222, 128, 0.5);
        }
        .kpi-card-trend .trend-indicator.down {
            color: #f87171;
            background-color: rgba(248, 113, 113, 0.15);
            border: 2px solid rgba(248, 113, 113, 0.5);
        }
        .kpi-card-trend .trend-indicator svg { width: 1.25rem; height: 1.25rem; }
        .sparkline-container { height: 50px; margin-top: auto; opacity: 0.7; }

        /* --- Section & Chart Styles --- */
        .section-title {
            font-size: 1.75rem; 
            font-weight: 700;
            color: #1a432b;
            margin-bottom: 2rem; 
            text-align: center;
        }
        @media (min-width: 768px) {
            .section-title { font-size: 2.25rem; margin-bottom: 2.5rem; }
        }
        .chart-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        .chart-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #285430;
            margin-bottom: 1rem;
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
            max-width: 800px;
            margin: auto;
        }
        .chart-context {
            text-align: center;
            font-size: 0.95rem;
            color: #557A46;
            margin-top: 1.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* --- Modal Styles --- */
        #details-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 999;
            display: none; opacity: 0; transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #details-modal-container {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: #f9fafb; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 90%; max-width: 900px; max-height: 90vh;
            overflow: hidden; display: none; opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 1000; display: flex; flex-direction: column;
        }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .modal-close-btn {
            background-color: #e5e7eb; color: #4b5563; border-radius: 9999px;
            width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; line-height: 1; transition: background-color 0.2s, color 0.2s;
        }
        .modal-close-btn:hover { background-color: #d1d5db; color: #1f2937; }
        #details-modal-overlay.visible { display: block; opacity: 1; }
        #details-modal-container.visible { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        /* --- Table & Badge Styles --- */
        .professional-table { width: 100%; border-collapse: collapse; }
        .professional-table thead th {
            background-color: #285430; color: white; padding: 0.75rem 1rem;
            text-align: right; font-weight: 600;
        }
        .professional-table tbody td {
            padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb; color: #374151;
        }
        .professional-table tbody tr:nth-child(even) { background-color: #f3f4f6; }
        .professional-table tbody tr:hover { background-color: #e5e7eb; }
        .professional-table .icon {
            display: inline-block; vertical-align: middle; margin-left: 8px;
            width: 20px; height: 20px;
        }
        .professional-table .amount { font-weight: 600; }
        .professional-table .amount.overdue { color: #c81e1e; }
        .status-badge {
            padding: 0.25rem 0.75rem; border-radius: 9999px;
            font-weight: 600; font-size: 0.8rem;
        }
        .status-badge.resolved { background-color: #dcfce7; color: #166534; }
        .status-badge.pending { background-color: #fef9c3; color: #854d0e; }
    </style>
</head>
<body class="antialiased">
    <div id="bg-left" class="background-image-container"></div>
    <div id="bg-right" class="background-image-container"></div>
    
    <div class="main-content-area">
        <div class="main-container">
            <!-- Header Section -->
            <header class="text-center mb-8 md:mb-12">
                <div class="flex flex-col sm:flex-row justify-center items-center w-full mb-4 gap-4">
                    <!-- Updated Image Source -->
                    <img src="photo/logo gov.gif" alt="logo gov" class="h-24 md:h-32 w-auto object-contain">
                    <div class="flex-grow mx-4">
                        <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-extrabold text-gray-800">
                            لوحة مؤشرات الأداء
                        </h1>
                        <p class="text-base md:text-lg text-gray-600 mt-1">صندوق استصلاح الأراضي</p>
                    </div>
                    <!-- Updated Image Source -->
                    <img src="photo/logo box.png" alt="logo box" class="h-24 md:h-32 w-auto object-contain">
                </div>
            </header>

            <main>
                <!-- Financial Vision Section -->
                <section id="financial" class="mb-12">
                    <h2 class="section-title">💰 الرؤية المالية</h2>
                    
                    <!-- New Layout for Top Financial Cards -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 mb-8">
                        <!-- Left Column: Stacked Cards -->
                        <div class="flex flex-col gap-6 lg:gap-8">
                            <div data-kpi-id="revenue" class="kpi-card kpi-card-interactive text-center flex-1" data-animate-value="true">
                                <h3 class="kpi-title text-xl">إجمالي الإيرادات</h3>
                                <div><span class="kpi-value text-4xl">75.4</span><span class="kpi-unit text-base">مليون</span></div>
                            </div>
                            <div data-kpi-id="dues-amount" class="kpi-card kpi-card-interactive text-center flex-1" data-animate-value="true">
                                <h3 class="kpi-title text-xl">المستحقات المتأخرة</h3>
                                <div><span class="kpi-value text-4xl" style="color: #c81e1e;">12.1</span><span class="kpi-unit text-base">مليون</span></div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Tall Trend Card -->
                        <div class="kpi-card kpi-card-trend h-full" data-animate-kpi>
                             <h3 class="kpi-title">نمو الإيرادات الشهري</h3>
                            <div class="text-center my-auto">
                                <span id="trend-kpi-value" class="kpi-value text-4xl">0.0</span>
                                <span class="kpi-unit text-lg">مليون</span>
                                <div class="trend-indicator-wrapper mt-4">
                                    <div id="trend-indicator" class="trend-indicator !w-20 !h-20"></div>
                                </div>
                            </div>
                            <div class="sparkline-container mt-auto">
                                <canvas id="revenueTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Grid for the rest of the financial cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 text-center">
                        <div data-kpi-id="overdue" class="kpi-card kpi-card-interactive kpi-card-warning" data-animate-value="false">
                            <h3 class="kpi-title">أقساط متأخرة (عدد)</h3>
                            <div><span class="kpi-value">245</span><span class="kpi-unit">قسط</span></div>
                        </div>
                         <div class="kpi-card">
                            <h3 class="kpi-title">أعلى مركز تحصيلاً</h3>
                            <div><span id="top-revenue-center" class="kpi-value text-green-600"></span></div>
                        </div>
                         <div class="kpi-card" data-animate-value="true">
                            <h3 class="kpi-title">نسبة التحصيل</h3>
                            <div><span class="kpi-value">86.2</span><span class="kpi-unit">%</span></div>
                        </div>
                    </div>

                     <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                          <div class="chart-card" data-chart-id="overdueInstallmentsChart">
                            <h3 class="chart-title">توزيع الأقساط المتأخرة (آخر 6 شهور)</h3>
                            <div class="chart-container"><canvas id="overdueInstallmentsChart"></canvas></div>
                        </div>
                          <div class="chart-card" data-chart-id="revenueByCenterChart">
                            <h3 class="chart-title">توزيع الإيرادات حسب المراكز</h3>
                            <div class="chart-container"><canvas id="revenueByCenterChart"></canvas></div>
                        </div>
                     </div>
                </section>
                
                <!-- Allocation Vision Section -->
                <section id="allocation" class="mb-12">
                    <h2 class="section-title">🏞️ رؤية التخصيص</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div class="kpi-card text-center" data-animate-value="false"><h3 class="kpi-title">إجمالي الطلبات</h3><div><span class="kpi-value">1520</span><span class="kpi-unit">طلب</span></div></div>
                            <div class="kpi-card text-center" data-animate-value="false"><h3 class="kpi-title">طلبات موافق عليها</h3><div><span class="kpi-value">980</span><span class="kpi-unit">طلب</span></div></div>
                            <div class="kpi-card text-center" data-animate-value="false"><h3 class="kpi-title">أراض مخصصة</h3><div><span class="kpi-value">855</span><span class="kpi-unit">قطعة</span></div></div>
                            <div class="kpi-card text-center" data-animate-value="false"><h3 class="kpi-title">متوسط مدة التخصيص</h3><div><span class="kpi-value">45</span><span class="kpi-unit">يوم</span></div></div>
                        </div>
                        <div class="chart-card flex flex-col justify-center items-center" data-chart-id="landTypeChart">
                            <h3 class="chart-title">توزيع الأراضي حسب النوع</h3>
                            <div class="chart-container" style="height: 280px; max-width: 280px;"><canvas id="landTypeChart"></canvas></div>
                            <p class="chart-context">يعكس ديناميكية العرض والطلب بين الأراضي المطروحة والمقترحة.</p>
                        </div>
                    </div>
                </section>

                <section id="execution" class="mb-12">
                    <h2 class="section-title">🚧 رؤية التنفيذ والمتابعة</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                        <div data-kpi-id="completed-projects" class="kpi-card kpi-card-interactive" data-animate-value="false">
                            <h3 class="kpi-title">مشاريع تم تنفيذها</h3>
                             <div><span class="kpi-value">412</span><span class="kpi-unit">مشروع</span></div>
                        </div>
                        <div data-kpi-id="withdrawn-lands" class="kpi-card kpi-card-interactive" data-animate-value="false">
                            <h3 class="kpi-title">أراضٍ تم سحبها</h3>
                             <div><span class="kpi-value">58</span><span class="kpi-unit">قطعة</span></div>
                        </div>
                        <div data-kpi-id="late-investors" class="kpi-card kpi-card-interactive kpi-card-warning" data-animate-value="false">
                            <h3 class="kpi-title">مستثمرون متأخرون</h3>
                             <div><span class="kpi-value">97</span><span class="kpi-unit">مستثمر</span></div>
                        </div>
                    </div>
                </section>
                <section id="investors" class="mb-12">
                    <h2 class="section-title">📊 مؤشرات فاعلية المستثمرين</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mb-8 text-center">
                         <div data-kpi-id="registered-investors" class="kpi-card kpi-card-interactive" data-animate-value="false">
                            <h3 class="kpi-title">المستثمرون المسجلون</h3>
                            <div><span class="kpi-value">550</span><span class="kpi-unit">مستثمر</span></div>
                        </div>
                        <div data-kpi-id="active-investors" class="kpi-card kpi-card-interactive" data-animate-value="false">
                            <h3 class="kpi-title">المستثمرون النشطون</h3>
                            <div><span class="kpi-value">215</span><span class="kpi-unit">مستثمر</span></div>
                        </div>
                        <div class="kpi-card" data-animate-value="false">
                            <h3 class="kpi-title">نسبة التفاعل اليومي</h3>
                            <div><span class="kpi-value">42</span><span class="kpi-unit">%</span></div>
                        </div>
                        <div class="kpi-card" data-animate-value="false">
                            <h3 class="kpi-title">مشاريع جديدة شهرياً</h3>
                            <div><span class="kpi-value">15</span><span class="kpi-unit">مشروع</span></div>
                        </div>
                    </div>
                    <div class="chart-card" data-chart-id="investorDistributionChart">
                        <h3 class="chart-title">توزيع المستثمرين حسب حجم الاستثمار</h3>
                        <div class="chart-container"><canvas id="investorDistributionChart"></canvas></div>
                        <p class="chart-context">يعرض هذا المخطط شرائح المستثمرين بناءً على القيمة المالية لمشاريعهم.</p>
                    </div>
                </section>
                <section id="admin" class="mb-12">
                    <h2 class="section-title">⏳ مؤشرات زمنية وإدارية</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <div class="kpi-card text-center" data-animate-value="false"><h3 class="kpi-title">متوسط زمن القرار</h3><div><span class="kpi-value">21</span><span class="kpi-unit">يوم</span></div></div>
                        <div data-kpi-id="delayed-requests" class="kpi-card kpi-card-interactive text-center kpi-card-warning" data-animate-value="false"><h3 class="kpi-title">طلبات متأخرة</h3><div><span class="kpi-value">35</span><span class="kpi-unit">طلب</span></div></div>
                    </div>
                </section>
                <section id="complaints" class="mb-12">
                    <h2 class="section-title">⚖️ حالة الشكاوى والتظلمات</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 text-center">
                        <div data-kpi-id="total-complaints" class="kpi-card kpi-card-interactive" data-animate-value="false">
                            <h3 class="kpi-title">إجمالي الشكاوى</h3>
                            <div><span class="kpi-value">4</span><span class="kpi-unit">شكوى</span></div>
                        </div>
                        <div data-kpi-id="resolved-complaints" class="kpi-card kpi-card-interactive" data-animate-value="false">
                            <h3 class="kpi-title">شكاوى تم حلها</h3>
                            <div><span class="kpi-value">2</span><span class="kpi-unit">شكوى</span></div>
                        </div>
                        <div data-kpi-id="pending-complaints" class="kpi-card kpi-card-interactive kpi-card-warning" data-animate-value="false">
                            <h3 class="kpi-title">قيد المراجعة</h3>
                            <div><span class="kpi-value">2</span><span class="kpi-unit">شكوى</span></div>
                        </div>
                    </div>
                    <div class="chart-card" data-chart-id="complaintsChart">
                        <h3 class="chart-title">نسبة الشكاوى المفتوحة والمغلقة</h3>
                        <div class="chart-container" style="height: 200px;"><canvas id="complaintsChart"></canvas></div>
                        <p class="chart-context">مؤشر لكفاءة التعامل مع شكاوى المستثمرين.</p>
                    </div>
                </section>
            </main>
    
            <footer class="text-center mt-12 pt-8 border-t border-gray-300">
                <p class="text-sm text-gray-600 font-light">&copy; 2024 صندوق استصلاح الأراضي، محافظة الوادي الجديد. جميع الحقوق محفوظة.</p>
            </footer>
        </div>
    </div>

    <!-- Modal and Script -->
    <div id="details-modal-overlay"></div>
    <div id="details-modal-container">
        <div class="modal-header flex justify-between items-center"><h3 id="details-modal-title" class="text-2xl font-bold text-[#285430]"></h3><button id="details-modal-close" class="modal-close-btn">&times;</button></div>
        <div class="modal-body"><div id="details-modal-content"></div></div>
    </div>

    <script defer>
        const mockData = {
            revenue: [
                { name: 'شركة النيل الزراعية', amount: '500,000', currency: 'ج.م', date: '2024-05-15', method: 'تحويل بنكي', installment: 3 },
                { name: 'مزارع الوادي الجديد', amount: '250,000', currency: 'ج.م', date: '2024-05-12', method: 'شيك', installment: 1 },
                { name: 'استثمارات الواحة الخضراء', amount: '16,400', currency: '$', date: '2024-05-11', method: 'تحويل بنكي', installment: 5 }
            ],
            duesAmount: [ { name: 'مستثمر الأمل', amount: '120,000 ج.م', dueDate: '2024-04-30' }, { name: 'أراضي الخير', amount: '85,000 ج.م', dueDate: '2024-05-10' }, { name: 'الرمال الذهبية', amount: '210,000 ج.م', dueDate: '2024-03-20' } ],
            overdue: { 
                monthlyDistribution: [{ month: 'يناير', count: 45 }, { month: 'فبراير', count: 60 }, { month: 'مارس', count: 55 },{ month: 'أبريل', count: 75 }, { month: 'مايو', count: 65 }, { month: 'يونيو', count: 85 }],
                yearlyDistribution: [{ year: '2022', count: 120 }, { year: '2023', count: 210 }, { year: '2024', count: 95 }],
                details: [{ name: 'شركة الصحراء الخضراء', installment: 2, amount: '75,000 ج.م', dueDate: '2024-06-01' },{ name: 'مستثمر المستقبل', installment: 4, amount: '90,000 ج.м', dueDate: '2024-06-05' },] 
            },
            completedProjects: [{ name: 'مشروع القمح الذهبي', investor: 'شركة النيل الزراعية', date: '2023-12-20', area: '500 فدان' },{ name: 'مزارع الزيتون المبارك', investor: 'استثمار الواحات', date: '2024-02-11', area: '1200 فدان' },],
            withdrawnLands: [
                { investor: 'شركة الرمال المتحركة', landId: 'ق-884-ب', reason: 'عدم الجدية', date: '2024-03-01', withdrawalRecordDate: '2024-02-20', decisionNumber: '155', decisionAuthority: 'مجلس الإدارة', withdrawalDecision: 'سحب نهائي' },
                { investor: 'مستثمر غير معروف', landId: 'س-101-ج', reason: 'مخالفة شروط التعاقد', date: '2024-05-18', withdrawalRecordDate: '2024-05-10', decisionNumber: '189', decisionAuthority: 'السيد المحافظ', withdrawalDecision: 'إنذار بالسحب' },
            ],
            lateInvestors: [{ name: 'مستثمر الأمل', overdueAmount: '120,000 ج.م', lastPayment: '2023-11-01', phone: '01001234567' },{ name: 'أراضي الخير', overdueAmount: '85,000 ج.م', lastPayment: '2024-01-15', phone: '01223456789' },],
            registeredInvestors: [{ name: 'شركة الوادي الجديد القابضة', joinDate: '2022-01-15', status: 'نشط' },{ name: 'مجموعة الأفق الزراعية', joinDate: '2022-03-10', status: 'نشط' },{ name: 'مستثمر فردي', joinDate: '2024-06-01', status: 'جديد' },],
            activeInvestors: [{ name: 'شركة الوادي الجديد القابضة', lastActivity: '2024-06-12', openProjects: 3 },{ name: 'مجموعة الأفق الزراعية', lastActivity: '2024-06-10', openProjects: 1 },],
            delayedRequests: [{ id: 'طلب-1984', type: 'تخصيص أرض', submitted: '2024-04-01', daysDelayed: 38 },{ id: 'طلب-2011', type: 'تغيير نشاط', submitted: '2024-04-15', daysDelayed: 24 },],
            complaints: [ { id: 'C-001', investor: 'شركة النيل', subject: 'تأخر في الرد', date: '2024-06-01', status: 'مغلقة', resolutionDate: '2024-06-05' }, { id: 'C-002', investor: 'مستثمر الأمل', subject: 'خطأ في الفاتورة', date: '2024-06-02', status: 'قيد المراجعة', resolutionDate: null }, ],
            monthlyRevenue: [10.2, 11.5, 11.1, 12.8, 12.5, 13.2],
            centerRevenue: [ { name: 'مركز الخارجة', revenue: 22.5 }, { name: 'مركز الداخلة', revenue: 18.1 }, { name: 'مركز الفرافرة', revenue: 15.8 }, { name: 'مركز باريس', revenue: 11.4 }, { name: 'مركز بلاط', revenue: 7.6 }, ]
        };

        const icons = {
            user: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`,
            money: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 004 0V7.15c.22.07.408.164.567.267C13.96 7.888 14 8.242 14 8.5v1.5a2.5 2.5 0 005 0V9a1 1 0 00-1-1h-.547l-1.35-1.35A.5.5 0 0015.5 6H14V5a1 1 0 00-1-1H7a1 1 0 00-1 1v1H4.5a.5.5 0 00-.354.146L2.793 7.5H2a1 1 0 00-1 1v1.5a2.5 2.5 0 005 0V8.5c0-.258-.04-.612-.433-1.082zM3 12.5a2.5 2.5 0 015 0V14a1 1 0 01-1 1H4a1 1 0 01-1-1v-1.5zM12 12.5a2.5 2.5 0 015 0V14a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1.5z" /></svg>`,
            calendar: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`,
        };

        document.addEventListener('DOMContentLoaded', () => {
            const modalOverlay = document.getElementById('details-modal-overlay');
            const modalContainer = document.getElementById('details-modal-container');
            const modalTitle = document.getElementById('details-modal-title');
            const modalContent = document.getElementById('details-modal-content');
            const closeModalBtn = document.getElementById('details-modal-close');
            const tooltipConfig = { plugins: { tooltip: { bodyFont: { family: 'Tajawal' }, titleFont: { family: 'Tajawal' }, rtl: true, }, legend: { labels: { font: { family: 'Tajawal', size: 14 } } } }, responsive: true, maintainAspectRatio: false };
            const chartColors = { primary: '#285430', secondary: '#557A46', light: '#A4B0A5', accent: '#D97706', danger: '#be123c' };

            const openModal = () => { modalOverlay.classList.add('visible'); modalContainer.classList.add('visible'); };
            const closeModal = () => { modalOverlay.classList.remove('visible'); modalContainer.classList.remove('visible'); };

            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);

            const generateContent = (type) => {
                let html = '';
                let title = '';
                const tableTemplate = (headers, rows) => `<div class="overflow-x-auto"><table class="professional-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table></div>`;
                
                switch (type) {
                    case 'revenue': 
                        title = 'تفاصيل الإيرادات المحصلة'; 
                        html = tableTemplate(
                            `<th>${icons.user}اسم المستثمر</th><th>${icons.money}المبلغ</th><th>${icons.calendar}التاريخ</th>`, 
                            mockData.revenue.map(item => 
                                `<tr>
                                    <td>${item.name}</td>
                                    <td class="amount">${item.amount} ${item.currency}</td>
                                    <td>${item.date}</td>
                                </tr>`
                            ).join('')
                        ); 
                        break;
                    case 'dues-amount': title = 'تفاصيل المستحقات المتأخرة'; html = tableTemplate(`<th>${icons.user}اسم المستثمر</th><th>${icons.money}المبلغ المستحق</th><th>${icons.calendar}تاريخ الاستحقاق</th>`, mockData.duesAmount.map(item => `<tr><td>${item.name}</td><td class="amount overdue">${item.amount}</td><td>${item.dueDate}</td></tr>`).join('')); break;
                    case 'overdue': 
                        title = 'تفاصيل الأقساط المتأخرة'; 
                        html = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">التوزيع الشهري للسنه الحالية</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    ${mockData.overdue.monthlyDistribution.map(item => `
                                        <div class="bg-amber-100 p-3 rounded-lg text-center border border-amber-200">
                                            <div class="font-bold text-amber-800">${item.month}</div>
                                            <div class="text-2xl font-extrabold text-amber-600">${item.count}</div>
                                        </div>`).join('')}
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">التوزيع السنوي للسنوات السابقة</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    ${mockData.overdue.yearlyDistribution.map(item => `
                                        <div class="bg-sky-100 p-3 rounded-lg text-center border border-sky-200">
                                            <div class="font-bold text-sky-800">${item.year}</div>
                                            <div class="text-2xl font-extrabold text-sky-600">${item.count}</div>
                                        </div>`).join('')}
                                </div>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-700 mb-3 mt-6">عينة من الأقساط</h4>` + 
                        tableTemplate(`<th>${icons.user}اسم المستثمر</th><th># القسط</th><th>${icons.money}المبلغ</th><th>${icons.calendar}تاريخ الاستحقاق</th>`, mockData.overdue.details.map(item => `<tr><td>${item.name}</td><td class="text-center">${item.installment}</td><td class="amount overdue">${item.amount}</td><td>${item.dueDate}</td></tr>`).join('')); 
                        break;
                    case 'completed-projects': title = 'المشاريع المنفذة'; html = tableTemplate(`<th>اسم المشروع</th><th>المستثمر</th><th>تاريخ الاكتمال</th><th>المساحة</th>`, mockData.completedProjects.map(item => `<tr><td>${item.name}</td><td>${item.investor}</td><td>${item.date}</td><td>${item.area}</td></tr>`).join('')); break;
                    case 'withdrawn-lands': 
                        title = 'الأراضي المسحوبة'; 
                        html = tableTemplate(
                            `<th>المستثمر</th><th>رقم القطعة</th><th>سبب السحب</th><th>تاريخ محضر السحب</th><th>رقم القرار</th><th>جهة القرار</th><th>قرار السحب</th>`, 
                            mockData.withdrawnLands.map(item => 
                                `<tr>
                                    <td>${item.investor}</td>
                                    <td>${item.landId}</td>
                                    <td class="amount overdue">${item.reason}</td>
                                    <td>${item.withdrawalRecordDate}</td>
                                    <td>${item.decisionNumber}</td>
                                    <td>${item.decisionAuthority}</td>
                                    <td>${item.withdrawalDecision}</td>
                                </tr>`
                            ).join('')
                        ); 
                        break;
                    case 'late-investors': title = 'المستثمرون المتأخرون في السداد'; html = tableTemplate(`<th>${icons.user}اسم المستثمر</th><th>${icons.money}المبلغ المتأخر</th><th>تاريخ آخر سداد</th><th>رقم الهاتف</th>`, mockData.lateInvestors.map(item => `<tr><td>${item.name}</td><td class="amount overdue">${item.overdueAmount}</td><td>${item.lastPayment}</td><td>${item.phone}</td></tr>`).join('')); break;
                    case 'registered-investors': title = 'قائمة المستثمرين المسجلين'; html = tableTemplate(`<th>${icons.user}اسم المستثمر</th><th>تاريخ الانضمام</th><th>الحالة</th>`, mockData.registeredInvestors.map(item => `<tr><td>${item.name}</td><td>${item.joinDate}</td><td><span class="px-2 py-1 font-semibold leading-tight ${item.status === 'نشط' ? 'text-green-700 bg-green-100' : 'text-blue-700 bg-blue-100'} rounded-full">${item.status}</span></td></tr>`).join('')); break;
                    case 'active-investors': title = 'قائمة المستثمرين النشطين'; html = tableTemplate(`<th>${icons.user}اسم المستثمر</th><th>آخر نشاط</th><th>مشاريع مفتوحة</th>`, mockData.activeInvestors.map(item => `<tr><td>${item.name}</td><td>${item.lastActivity}</td><td class="text-center">${item.openProjects}</td></tr>`).join('')); break;
                    case 'delayed-requests': title = 'الطلبات المتأخرة عن الجدول الزمني'; html = tableTemplate(`<th>رقم الطلب</th><th>نوع الطلب</th><th>تاريخ التقديم</th><th>أيام التأخير</th>`, mockData.delayedRequests.map(item => `<tr><td>${item.id}</td><td>${item.type}</td><td>${item.submitted}</td><td class="text-center amount overdue">${item.daysDelayed}</td></tr>`).join('')); break;
                    case 'total-complaints': title = 'إجمالي الشكاوى والتظلمات'; html = tableTemplate(`<th>رقم الشكوى</th><th>المشتكي</th><th>الموضوع</th><th>تاريخها</th><th>الحالة</th>`, mockData.complaints.map(item => `<tr><td>${item.id}</td><td>${item.investor}</td><td>${item.subject}</td><td>${item.date}</td><td><span class="status-badge ${item.status === 'مغلقة' ? 'resolved' : 'pending'}">${item.status}</span></td></tr>`).join('')); break;
                    case 'resolved-complaints': title = 'الشكاوى التي تم حلها'; html = tableTemplate(`<th>رقم الشكوى</th><th>المشتكي</th><th>الموضوع</th><th>تاريخ الحل</th>`, mockData.complaints.filter(c => c.status === 'مغلقة').map(item => `<tr><td>${item.id}</td><td>${item.investor}</td><td>${item.subject}</td><td>${item.resolutionDate}</td></tr>`).join('')); break;
                    case 'pending-complaints': title = 'شكاوى قيد المراجعة'; html = tableTemplate(`<th>رقم الشكوى</th><th>المشتكي</th><th>الموضوع</th><th>تاريخ التقديم</th>`, mockData.complaints.filter(c => c.status === 'قيد المراجعة').map(item => `<tr><td>${item.id}</td><td>${item.investor}</td><td>${item.subject}</td><td>${item.date}</td></tr>`).join('')); break;
                }
                modalTitle.innerText = title;
                modalContent.innerHTML = html;
            };

            document.querySelectorAll('.kpi-card-interactive').forEach(card => {
                card.addEventListener('click', () => {
                    const kpiId = card.dataset.kpiId;
                    if(kpiId) {
                        generateContent(kpiId);
                        openModal();
                    }
                });
            });
        
            function animateValue(element, start, end, duration, isDecimal = true) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const currentValue = progress * (end - start) + start;
                    element.textContent = isDecimal ? currentValue.toFixed(1) : Math.floor(currentValue);
                    if (progress < 1) { window.requestAnimationFrame(step); } 
                    else { element.textContent = isDecimal ? end.toFixed(1) : end; }
                };
                window.requestAnimationFrame(step);
            }

            const topCenterEl = document.getElementById('top-revenue-center');
            const topCenter = mockData.centerRevenue.reduce((prev, current) => (prev.revenue > current.revenue) ? prev : current);
            topCenterEl.textContent = topCenter.name;

            const chartInitializer = (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const chartId = entry.target.dataset.chartId;
                        const kpiCardEl = entry.target.hasAttribute('data-animate-kpi');
                        const animatedValueEl = entry.target.querySelector('.kpi-value');

                        if (kpiCardEl && !entry.target.isAnimated) {
                            entry.target.isAnimated = true; // Prevents re-animation on scroll
                            const trendValueEl = document.getElementById('trend-kpi-value');
                            const trendIndicatorEl = document.getElementById('trend-indicator');
                            const monthlyRevenueData = mockData.monthlyRevenue;
                            const currentMonthRevenue = monthlyRevenueData[monthlyRevenueData.length - 1];
                            const previousMonthRevenue = monthlyRevenueData[monthlyRevenueData.length - 2];
                            const percentageChange = ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100;
                            const isUp = percentageChange >= 0;
                            
                            animateValue(trendValueEl, 0, currentMonthRevenue, 1500);
                            trendIndicatorEl.classList.add(isUp ? 'up' : 'down');
                            trendIndicatorEl.classList.remove(isUp ? 'down' : 'up');
                            const arrow = isUp ? `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" /></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" /></svg>`;
                            const percentageSpan = document.createElement('span');
                            percentageSpan.textContent = '0.0';
                            trendIndicatorEl.innerHTML = `${arrow}`;
                            trendIndicatorEl.appendChild(percentageSpan);
                            percentageSpan.append('%');
                            animateValue(percentageSpan, 0, Math.abs(percentageChange), 1500);
                            
                            new Chart(document.getElementById('revenueTrendChart'), { type: 'line', data: { labels: ['', '', '', '', '', ''], datasets: [{ data: monthlyRevenueData, borderColor: 'white', borderWidth: 2, fill: true, backgroundColor: 'rgba(255, 255, 255, 0.1)', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { point: { radius: 0 } } } });
                            
                            observer.unobserve(entry.target);
                        }
                        
                        if (entry.target.hasAttribute('data-animate-value') && !entry.target.isAnimated) {
                            entry.target.isAnimated = true;
                            const isDecimal = entry.target.dataset.animateValue === 'true';
                            const value = parseFloat(animatedValueEl.textContent);
                            animateValue(animatedValueEl, 0, value, 1500, isDecimal);
                            observer.unobserve(entry.target);
                        }

                        if (chartId && !entry.target.chart) {
                             switch(chartId) {
                                 case 'overdueInstallmentsChart': entry.target.chart = new Chart(document.getElementById('overdueInstallmentsChart'), { type: 'bar', data: { labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'], datasets: [{ label: 'عدد الأقساط المتأخرة', data: [45, 60, 55, 75, 65, 85], backgroundColor: chartColors.secondary, borderColor: chartColors.primary, borderWidth: 1, borderRadius: 5 }] }, options: { ...tooltipConfig, scales: { y: { beginAtZero: true, ticks: { font: { family: 'Tajawal' } } }, x: { ticks: { font: { family: 'Tajawal' } } } } } }); break;
                                 case 'revenueByCenterChart': entry.target.chart = new Chart(document.getElementById('revenueByCenterChart'), { type: 'bar', data: { labels: mockData.centerRevenue.map(c => c.name), datasets: [{ label: 'الإيرادات بالمليون', data: mockData.centerRevenue.map(c => c.revenue), backgroundColor: [chartColors.primary, chartColors.secondary, chartColors.light, chartColors.accent, '#A47E3B'], borderWidth: 0, borderRadius: 5 }] }, options: { ...tooltipConfig, indexAxis: 'y', plugins: { ...tooltipConfig.plugins, legend: { display: false } }, scales: { y: { ticks: { font: { family: 'Tajawal' } } }, x: { ticks: { font: { family: 'Tajawal' } } } } } }); break;
                                 case 'landTypeChart': entry.target.chart = new Chart(document.getElementById('landTypeChart'), { type: 'doughnut', data: { labels: ['أراضٍ مطروحة', 'أراضٍ مقترحة'], datasets: [{ data: [68, 32], backgroundColor: [chartColors.primary, chartColors.light], borderColor: '#ffffff', borderWidth: 4 }] }, options: { ...tooltipConfig, plugins: { ...tooltipConfig.plugins, legend: { position: 'bottom', ...tooltipConfig.plugins.legend } } } }); break;
                                 case 'investorDistributionChart': entry.target.chart = new Chart(document.getElementById('investorDistributionChart'), { type: 'bar', data: { labels: ['أقل من 1م', '1-5م', '5-10م', 'أكثر من 10م'], datasets: [{ label: 'عدد المستثمرين', data: [110, 65, 32, 8], backgroundColor: [chartColors.light, chartColors.secondary, chartColors.primary, chartColors.accent], borderWidth: 0, borderRadius: 5 }] }, options: { ...tooltipConfig, plugins: { ...tooltipConfig.plugins, legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { font: { family: 'Tajawal' } } }, x: { ticks: { font: { family: 'Tajawal' } } } } } }); break;
                                 case 'complaintsChart': const resolvedCount = mockData.complaints.filter(c => c.status === 'مغلقة').length; const pendingCount = mockData.complaints.filter(c => c.status === 'قيد المراجعة').length; entry.target.chart = new Chart(document.getElementById('complaintsChart'), { type: 'bar', data: { labels: ['حالة الشكاوى'], datasets: [{ label: 'مغلقة', data: [resolvedCount], backgroundColor: chartColors.secondary, borderRadius: 5 }, { label: 'مفتوحة', data: [pendingCount], backgroundColor: chartColors.danger, borderRadius: 5 }] }, options: { ...tooltipConfig, indexAxis: 'y', scales: { x: { stacked: true, ticks: { callback: (v) => v, font: { family: 'Tajawal' } } }, y: { stacked: true, ticks: { font: { family: 'Tajawal' } } } } } }); break;
                             }
                             observer.unobserve(entry.target);
                        }
                    }
                });
            };
            const chartObserver = new IntersectionObserver(chartInitializer, { rootMargin: "0px", threshold: 0.1 });
            document.querySelectorAll('[data-chart-id], [data-animate-kpi], [data-animate-value]').forEach(el => chartObserver.observe(el));
        });
    </script>
</body>
</html>
